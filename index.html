<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Quick Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-green: #10b981;
            --primary-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-amber: #f59e0b;
            --accent-cyan: #06b6d4;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-dark: #334155;
            --text-gray: #64748b;
            --border-light: #e2e8f0;
            --shadow-soft: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: "Noto Sans JP", "Inter", sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f8fafc 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
            color: var(--text-dark);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }
        @media (min-width: 640px) {
            .container-spacing {
                max-width: 500px;
            }
        }
        @media (min-width: 768px) {
            .container-spacing {
                max-width: 600px;
            }
        }
        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 700px;
            }
        }
        .game-title {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--primary-blue);
            text-align: center;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }
        .clean-card {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }
        .clean-button {
            background: var(--primary-blue);
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        .clean-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-soft);
            background: #2563eb;
        }
        .clean-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        .subject-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            color: var(--text-dark);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 1rem 0.75rem;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        .subject-btn:hover {
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-soft);
        }
        .subject-btn.active {
            background: #eff6ff;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-soft);
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }
        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        /* éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #voiceSettingsModal {
            align-items: flex-start;
            padding-top: 3rem;
        }
        
        #voiceSettingsModal .clean-card {
            margin-top: 0;
            margin-bottom: 2rem;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 600;
            z-index: 100;
            animation: particleFloat 2s ease-out forwards;
            font-size: 18px;
        }
        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.2);
                opacity: 0;
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-white);
            color: var(--text-dark);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            box-shadow: 0 4px 12px var(--shadow-soft);
        }
        .notification.show {
            transform: translateX(0);
        }
        .floating-button {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary-blue);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-soft);
            transition: all 0.2s ease;
            z-index: 1002;
            cursor: pointer;
        }
        
        .floating-button.hidden {
            display: none !important;
        }
        .floating-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-soft);
        }

        /* éŸ³å£°è¨­å®šãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .voice-settings-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary-green);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-soft);
            transition: all 0.2s ease;
            z-index: 1002;
            cursor: pointer;
        }
        
        .voice-settings-button.hidden {
            display: none !important;
        }
        
        .voice-settings-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow-soft);
            background: #059669;
        }

        .quiz-option {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            color: var(--text-dark);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        .quiz-option:hover {
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-soft);
        }
        .quiz-explanation {
            height: 150px;
            background: #f8fafc;
            border-radius: 10px;
            padding: 0.75rem;
            margin-top: 1rem;
            border: 2px solid var(--border-light);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
        }
        .quiz-explanation p {
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            max-height: 100%;
            overflow: hidden;
            font-size: 1rem;
        }
        .quiz-explanation.has-content {
            border-color: var(--primary-green);
            background: #f0fdf4;
        }
        .subject-modal-content {
            max-height: 80vh;
            overflow-y: auto;
            padding-top: 0;
        }
        
        .modal .clean-card {
            margin: 1rem auto;
            max-height: 80vh;
            overflow-y: auto;
            width: calc(100% - 2rem);
            max-width: 500px;
            box-sizing: border-box;
        }
        
        /* ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
        #quizModal .clean-card {
            margin: 1rem auto;
            padding: 1rem;
            width: calc(100% - 2rem);
            max-width: 500px;
            box-sizing: border-box;
        }
        
        /* å•é¡Œæ–‡ã®ä¸­å¤®æƒãˆä¿®æ­£ */
        #quizQ {
            font-size: 1rem;
            line-height: 1.4;
            text-align: center !important;
            margin: 0 auto;
            padding: 0 1rem;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            display: block;
        }
        
        @media (max-width: 640px) {
            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
            .modal .clean-card {
                margin: 1rem 0.25rem;
                padding: 0.75rem;
                max-height: 85vh;
                width: calc(100% - 0.5rem);
            }
            
            #quizModal .clean-card {
                margin: 1rem 0.25rem;
                padding: 0.75rem;
                width: calc(100% - 0.5rem);
                max-width: none;
            }
            
            /* å•é¡Œæ–‡ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
            #quizQ {
                font-size: 0.9rem;
                line-height: 1.3;
                text-align: center !important;
                margin: 0;
                padding: 0 0.5rem;
                width: 100%;
                display: block;
                word-wrap: break-word;
            }
            
            .subject-modal-content {
                max-height: 85vh;
                padding-top: 0;
            }
            
            /* éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
            #voiceSettingsModal {
                padding-top: 2rem;
            }
            
            #voiceSettingsModal .clean-card {
                margin: 0.5rem 0.25rem 2rem 0.25rem;
            }
        }
        .subject-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        .category-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.5rem;
        }
        .back-button {
            background: #f1f5f9;
            border: 1px solid var(--border-light);
            color: var(--text-dark);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        .back-button:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        .category-btn {
            background: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-dark);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 60px;
            box-shadow: 0 1px 3px var(--shadow-soft);
            font-size: 0.8rem;
            font-weight: 500;
        }
        .category-btn:hover {
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px var(--shadow-soft);
        }
        .category-btn.active {
            background: #eff6ff;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px var(--shadow-soft);
        }
        .stats-display {
            background: #f8fafc;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        .section-divider {
            height: 1px;
            background: var(--border-light);
            margin: 1rem 0;
        }
        .grade-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-gray);
            text-align: center;
            margin: 0.75rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* éŸ³å£°é¸æŠé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .voice-option {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        
        .voice-option:hover {
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-soft);
        }
        
        .voice-option.selected {
            border-color: var(--primary-green);
            background: #f0fdf4;
            box-shadow: 0 4px 8px var(--shadow-soft);
        }
        
        .voice-option.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .voice-preview-btn {
            background: var(--accent-cyan);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        
        .voice-preview-btn:hover {
            background: #0891b2;
            transform: translateY(-1px);
        }
        
        .voice-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .voice-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .voice-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }
        
        .voice-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .voice-slider {
            background: var(--primary-green);
        }
        
        input:checked + .voice-slider:before {
            transform: translateX(26px);
        }

        @media (max-width: 640px) {
            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }
            
            /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®ä½ç½®èª¿æ•´ */
            .floating-button {
                bottom: 20px;
                left: 20px;
                width: 52px;
                height: 52px;
                font-size: 20px;
            }

            .voice-settings-button {
                bottom: 20px;
                right: 20px;
                width: 52px;
                height: 52px;
                font-size: 20px;
            }
            
            .clean-card {
                margin: 0.5rem;
                padding: 1rem;
            }
            .clean-card:last-of-type {
                margin-bottom: 4rem;
            }
            body {
                padding-bottom: 5rem;
            }
            .game-title {
                font-size: clamp(1.25rem, 6vw, 2rem);
            }
            .subject-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            .category-grid {
                grid-template-columns: 1fr;
                gap: 0.4rem;
            }
            .subject-btn {
                padding: 0.75rem 0.5rem;
                min-height: 70px;
                font-size: 0.8rem;
            }
            .category-btn {
                padding: 0.6rem 0.4rem;
                min-height: 50px;
                font-size: 0.75rem;
            }
            .subject-icon {
                font-size: 1.5rem;
            }
            .quiz-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            .quiz-explanation {
                height: 120px;
                padding: 0.5rem;
                font-size: 0.9rem;
                line-height: 1.3;
            }
            .quiz-explanation p {
                font-size: 0.9rem;
            }
        }
        .mode-btn {
            background: var(--bg-white);
            border: 2px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-dark);
            transition: all 0.2s ease;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px var(--shadow-soft);
        }
        .mode-btn:hover {
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px var(--shadow-soft);
        }
        .mode-btn.active {
            background: #eff6ff;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px var(--shadow-soft);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
        .modal .clean-card .text-center:first-child {
            padding-top: 0.5rem;
        }
        
        .category-grid {
            padding-bottom: 1rem;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã‚’é©åˆ‡ã«è¨­å®š */
        #geographyModal .clean-card,
        #historyModal .clean-card,
        #civicsModal .clean-card,
        #chemistryModal .clean-card,
        #biologyModal .clean-card,
        #physicsModal .clean-card,
        #earthModal .clean-card,
        #englishWordsModal .clean-card,
        #englishPhrasesModal .clean-card,
        #englishGrammarModal .clean-card {
            padding: 1rem;
            box-sizing: border-box;
        }
        /* ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢ */
        button, .subject-btn, .category-btn, .quiz-option, .clean-button, .back-button, .mode-btn {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        * {
            touch-action: manipulation;
        }
        
        /* iOS Safari ã®æ‹¡å¤§é˜²æ­¢ */
        input, select, textarea {
            font-size: 16px;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ”¹å–„ */
        .modal {
            padding: 0.5rem;
        }
        
        .modal .clean-card {
            position: relative;
            top: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <div id="mainSubjectModal" class="modal show">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h1 class="game-title">Quick Quiz</h1>
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“š æ•™ç§‘ã‚’é¸æŠ
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã—ãŸã„æ•™ç§‘ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn" data-subject="social">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">ç¤¾ä¼š</div>
                </button>
                <button class="subject-btn" data-subject="science">
                    <div class="subject-icon text-2xl mb-1">ğŸ”¬</div>
                    <div class="subject-name font-semibold text-sm">ç†ç§‘</div>
                </button>
                <button class="subject-btn" data-subject="english">
                    <div class="subject-icon text-2xl mb-1">ğŸ“–</div>
                    <div class="subject-name font-semibold text-sm">è‹±èª</div>
                </button>
            </div>
        </div>
    </div>

    <div id="socialModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ ç¤¾ä¼š
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn" data-category="geography">
                    <div class="subject-icon text-2xl mb-1">ğŸ—ºï¸</div>
                    <div class="subject-name font-semibold text-sm">åœ°ç†</div>
                </button>
                <button class="subject-btn" data-category="history">
                    <div class="subject-icon text-2xl mb-1">ğŸ›ï¸</div>
                    <div class="subject-name font-semibold text-sm">æ­´å²</div>
                </button>
                <button class="subject-btn" data-category="civics">
                    <div class="subject-icon text-2xl mb-1">âš–ï¸</div>
                    <div class="subject-name font-semibold text-sm">å…¬æ°‘</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="scienceModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ”¬ ç†ç§‘
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn" data-category="chemistry">
                    <div class="subject-icon text-2xl mb-1">ğŸ§ª</div>
                    <div class="subject-name font-semibold text-sm">åŒ–å­¦</div>
                </button>
                <button class="subject-btn" data-category="biology">
                    <div class="subject-icon text-2xl mb-1">ğŸ§¬</div>
                    <div class="subject-name font-semibold text-sm">ç”Ÿç‰©</div>
                </button>
                <button class="subject-btn" data-category="physics">
                    <div class="subject-icon text-2xl mb-1">âš›ï¸</div>
                    <div class="subject-name font-semibold text-sm">ç‰©ç†</div>
                </button>
                <button class="subject-btn" data-category="earth">
                    <div class="subject-icon text-2xl mb-1">ğŸŒ</div>
                    <div class="subject-name font-semibold text-sm">åœ°å­¦</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="englishModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-6">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“– è‹±èª
                </h2>
                <p class="text-gray-600 text-sm">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
            </div>
            <div class="grid subject-grid mb-6">
                <button class="subject-btn" data-category="english_words">
                    <div class="subject-icon text-2xl mb-1">ğŸ“</div>
                    <div class="subject-name font-semibold text-sm">è‹±å˜èª</div>
                </button>
                <button class="subject-btn" data-category="english_phrases">
                    <div class="subject-icon text-2xl mb-1">ğŸ’¬</div>
                    <div class="subject-name font-semibold text-sm">è‹±ç†Ÿèª</div>
                </button>
                <button class="subject-btn" data-category="english_grammar">
                    <div class="subject-icon text-2xl mb-1">ğŸ“˜</div>
                    <div class="subject-name font-semibold text-sm">èªå½¢å¤‰åŒ–</div>
                </button>
            </div>
            <div class="text-center">
                <button class="back-button" onclick="goBackToMain()">
                    â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="geographyModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ—ºï¸ åœ°ç†
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°ã®é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="geographyCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startGeographyQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ›ï¸ æ­´å²
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°ã®é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="historyCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startHistoryQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="civicsModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    âš–ï¸ å…¬æ°‘
                </h2>
                <p class="text-gray-600 text-sm"></p>
            </div>
            <div class="grid category-grid mb-4" id="civicsCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startCivicsQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToSocial()">
                    â† ç¤¾ä¼šã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="chemistryModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ§ª åŒ–å­¦
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="chemistryCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startChemistryQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="biologyModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ§¬ ç”Ÿç‰©
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="biologyCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startBiologyQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="physicsModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    âš›ï¸ ç‰©ç†
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="physicsCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startPhysicsQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="earthModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸŒ åœ°å­¦
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="earthCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startEarthQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToScience()">
                    â† ç†ç§‘ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="englishWordsModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“ è‹±å˜èª
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="englishWordsCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startEnglishWordsQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="englishPhrasesModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ’¬ è‹±ç†Ÿèª
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="englishPhrasesCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startEnglishPhrasesQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="englishGrammarModal" class="modal">
        <div class="clean-card p-6 container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">
                    ğŸ“˜ èªå½¢å¤‰åŒ–
                </h2>
                <p class="text-gray-600 text-sm">å­¦ç¿’ã™ã‚‹å˜å…ƒã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br>è¤‡æ•°é¸æŠã‚‚ã§ãã¾ã™ã€‚</p>
            </div>
            <div class="grid category-grid mb-4" id="englishGrammarCategories">
                </div>
            <div class="text-center space-y-2">
                <button id="startEnglishGrammarQuiz" class="clean-button px-6 py-2 text-sm" disabled>
                    æ±ºå®šã™ã‚‹
                </button>
                <br>
                <button class="back-button" onclick="goBackToEnglish()">
                    â† è‹±èªã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="voiceSettingsModal" class="modal">
        <div class="clean-card p-6 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">
                    ğŸ”Š éŸ³å£°è¨­å®š
                </h2>
                <p class="text-gray-600 text-sm">è‹±èªã®ç™ºéŸ³è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™</p>
            </div>
            
            <!-- éŸ³å£°ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ -->
            <div class="mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700">éŸ³å£°å†ç”Ÿ</span>
                    <label class="voice-toggle">
                        <input type="checkbox" id="voiceEnabled" checked>
                        <span class="voice-slider"></span>
                    </label>
                </div>
                <p class="text-xs text-gray-500 mt-1">è‹±èªã®å•é¡Œã§è‡ªå‹•ç™ºéŸ³ã‚’è¡Œã„ã¾ã™</p>
            </div>

            <div class="section-divider"></div>

            <!-- å¥³æ€§éŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">ğŸ‘© å¥³æ€§éŸ³å£°</h3>
                <div class="space-y-3" id="femaleVoices">
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- ç”·æ€§éŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">ğŸ‘¨ ç”·æ€§éŸ³å£°</h3>
                <div class="space-y-3" id="maleVoices">
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
            <div class="text-center">
                <button id="closeVoiceSettings" class="clean-button px-6 py-2 text-sm">
                    âœ… è¨­å®šå®Œäº†
                </button>
            </div>
        </div>
    </div>

    <div id="gameScreen" class="hidden">
        <div class="clean-card p-6 text-center container-spacing mb-6">
            <h1 class="game-title">Quick Quiz</h1>
            <div id="currentCategory" class="text-lg font-semibold text-gray-700 mb-4"></div>
<div class="stats-display">
    <div class="grid grid-cols-3 gap-4 text-center mb-4">
        <div>
            <div class="text-xl font-bold text-gray-800" id="correctCount">0</div>
            <div class="text-xs text-gray-600">æ­£è§£æ•°</div>
        </div>
        <div>
            <div class="text-xl font-bold text-gray-800" id="wrongCount">0</div>
            <div class="text-xs text-gray-600">ä¸æ­£è§£æ•°</div>
        </div>
        <div>
            <div class="text-xl font-bold text-gray-800" id="totalCount">0</div>
            <div class="text-xs text-gray-600">ç·å•é¡Œæ•°</div>
        </div>
    </div>
    
    <!-- æ–°ã—ãè¿½åŠ ã™ã‚‹å‡ºé¡Œå½¢å¼é¸æŠéƒ¨åˆ† -->
    <div class="section-divider"></div>
    <div class="text-center">
        <div class="text-sm font-semibold text-gray-700 mb-3">ğŸ“‹ å‡ºé¡Œå½¢å¼</div>
        <div class="grid grid-cols-2 gap-2">
            <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                ğŸ² ãƒ©ãƒ³ãƒ€ãƒ 
            </button>
            <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                ğŸ“‹ é †ç•ªé€šã‚Š
            </button>
        </div>
        <div class="text-xs text-gray-600 mt-2" id="modeDescription">
            å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™
        </div>
    </div>
</div>
            <button id="startQuizButton" class="clean-button px-6 py-3 text-base font-semibold mt-6">
                âœ¨ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>
    </div>

    <div id="quizModal" class="modal">
        <div class="clean-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-semibold text-lg text-gray-700">
                    âœ¨ Quick Quiz
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-base font-medium text-center text-gray-800 leading-relaxed"></p>
                <div id="quizOptions" class="space-y-2"></div>
                <div id="quizExplanation" class="quiz-explanation">
                    <p id="quizMsg" class="font-semibold text-center text-base"></p>
                </div>
                <div class="flex gap-2">
                    <button id="quizNext" class="flex-1 clean-button py-2 text-sm">
                        ğŸŒŸ æ¬¡ã®å•é¡Œ
                    </button>
                    <button id="quizBack" class="flex-1 back-button py-2 text-sm">
                        ğŸ  æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <button id="changeSubject" class="floating-button hidden">
        ğŸ“š
    </button>

    <!-- éŸ³å£°è¨­å®šãƒœã‚¿ãƒ³ -->
    <button id="voiceSettingsButton" class="voice-settings-button hidden">
        ğŸ”Š
    </button>

    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-xl">âœ¨</span>
            <div>
                <div class="font-semibold text-sm">Quick Quiz</div>
                <div id="notificationText" class="text-xs text-gray-600"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- åŠ¹æœéŸ³ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
            }

            playClick() {
                this.createTone(800, 0.1, 0.05, 'square');
            }

            playCorrect() {
                this.createTone(523, 0.1, 0.3);
                setTimeout(() => this.createTone(659, 0.1, 0.3), 150);
                setTimeout(() => this.createTone(784, 0.2, 0.3), 300);
            }

            playWrong() {
                this.createTone(200, 0.3, 0.3, 'sawtooth');
            }

            playSuccess() {
                const notes = [523, 587, 659, 698, 784, 880, 988, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.createTone(freq, 0.15, 0.3), i * 100);
                });
            }

            createTone(frequency, duration, volume = 0.3, type = 'sine') {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        const soundSystem = new SoundSystem();

        /* ----------------- éŸ³å£°è¨­å®šã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰ ----------------- */
        class VoiceSettingsSystem {
            constructor() {
                this.settings = {
                    enabled: true,
                    selectedVoice: null
                };
                this.availableVoices = [];
                this.recommendedVoices = {
                    female: [
                        { name: 'Samantha', patterns: ['samantha'], description: 'è‡ªç„¶ã§èãå–ã‚Šã‚„ã™ã„' },
                        { name: 'Google US English Female', patterns: ['google', 'female', 'us'], description: 'ã‚¯ãƒªã‚¢ã§ç™ºéŸ³ãŒæ­£ç¢º' },
                        { name: 'Microsoft Zira', patterns: ['zira', 'microsoft'], description: 'è¦ªã—ã¿ã‚„ã™ã„å£°' }
                    ],
                    male: [
                        { name: 'Alex', patterns: ['alex'], description: 'æ¨™æº–çš„ã§èãå–ã‚Šã‚„ã™ã„' },
                        { name: 'Google US English Male', patterns: ['google', 'male', 'us'], description: 'ã¯ã£ãã‚Šã—ãŸç™ºéŸ³' },
                        { name: 'Microsoft David', patterns: ['david', 'microsoft'], description: 'è½ã¡ç€ã„ãŸå£°' }
                    ]
                };
                
                // åŒ…æ‹¬çš„ãªæ€§åˆ¥åˆ¤å®šç”¨ã®åå‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
                this.maleNames = new Set([
                    'alex', 'david', 'daniel', 'mike', 'michael', 'john', 'james', 'robert', 
                    'william', 'richard', 'charles', 'joseph', 'thomas', 'christopher', 
                    'matthew', 'anthony', 'mark', 'donald', 'steven', 'paul', 'andrew', 
                    'joshua', 'kenneth', 'kevin', 'brian', 'george', 'edward', 'ronald', 
                    'timothy', 'jason', 'jeffrey', 'ryan', 'jacob', 'gary', 'nicholas', 
                    'eric', 'jonathan', 'stephen', 'larry', 'justin', 'scott', 'brandon', 
                    'benjamin', 'samuel', 'frank', 'gregory', 'raymond', 'alexander', 
                    'patrick', 'jack', 'dennis', 'jerry', 'tyler', 'aaron', 'henry', 
                    'douglas', 'jose', 'peter', 'nathan', 'noah', 'ethan', 'mason', 
                    'liam', 'lucas', 'logan', 'oliver', 'aiden', 'elijah', 
                    'wayne', 'ralph', 'roy', 'eugene', 'louis', 'philip', 'bobby', 
                    'rocko', 'rocky', 'reed', 'rick', 'ray', 'rob', 'rod', 'rex'
                ]);
                
                this.femaleNames = new Set([
                    'samantha', 'zira', 'susan', 'karen', 'lisa', 'betty', 'helen', 
                    'sandra', 'donna', 'carol', 'ruth', 'sharon', 'michelle', 'laura', 
                    'sarah', 'kimberly', 'deborah', 'dorothy', 'nancy', 
                    'amy', 'angela', 'ashley', 'brenda', 'emma', 'olivia', 'sophia', 
                    'isabella', 'charlotte', 'amelia', 'evelyn', 'abigail', 'harper', 
                    'emily', 'elizabeth', 'avery', 'sofia', 'ella', 'madison', 'scarlett', 
                    'victoria', 'aria', 'grace', 'chloe', 'camila', 'penelope', 'riley', 
                    'layla', 'lillian', 'nora', 'zoe', 'mia', 'ava', 'anna', 'alice', 
                    'shelley', 'shelly', 'sandy', 'mandy', 'cindy', 'wendy', 'judy', 
                    'mary', 'patricia', 'jennifer', 'linda', 'barbara', 
                    'jessica', 'tina', 'tanya', 'tracy', 'stephanie', 'nicole',
                    'grandma', 'grandmother', 'mom', 'mother', 'aunt', 'sister'
                ]);
                
                this.loadSettings();
                this.initVoices();
            }

            initVoices() {
                if ('speechSynthesis' in window) {
                    // éŸ³å£°ãƒªã‚¹ãƒˆã®åˆæœŸåŒ–ã‚’å¾…ã¤
                    const loadVoices = () => {
                        this.availableVoices = speechSynthesis.getVoices()
                            .filter(voice => voice.lang.startsWith('en-'));
                        
                        if (this.availableVoices.length > 0) {
                            this.setupVoiceSettings();
                        }
                    };

                    // éŸ³å£°ãƒªã‚¹ãƒˆãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
                    if (speechSynthesis.getVoices().length > 0) {
                        loadVoices();
                    } else {
                        // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
                        speechSynthesis.addEventListener('voiceschanged', loadVoices);
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        setTimeout(loadVoices, 1000);
                    }
                }
            }

            findRecommendedVoice(recommendation) {
                return this.availableVoices.find(voice => {
                    const voiceName = voice.name.toLowerCase();
                    return recommendation.patterns.every(pattern => 
                        voiceName.includes(pattern.toLowerCase())
                    );
                }) || null;
            }

            determineVoiceGender(voice) {
                const voiceName = voice.name.toLowerCase();
                
                // æ˜ç¤ºçš„ãªæ€§åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
                if (voiceName.includes('female') || voiceName.includes('woman') || voiceName.includes('girl')) {
                    return 'female';
                }
                if (voiceName.includes('male') || voiceName.includes('man') || voiceName.includes('boy')) {
                    return 'male';
                }
                
                // åå‰ã‹ã‚‰æ€§åˆ¥ã‚’æ¨å®šï¼ˆæœ€åˆã®å˜èªã‚’å–å¾—ï¼‰
                const nameMatch = voiceName.match(/^(\w+)/);
                if (nameMatch) {
                    const firstName = nameMatch[1].toLowerCase();
                    if (this.femaleNames.has(firstName)) {
                        return 'female';
                    }
                    if (this.maleNames.has(firstName)) {
                        return 'male';
                    }
                }
                
                // ç‰¹åˆ¥ãªã‚±ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
                if (voiceName.includes('grandma') || voiceName.includes('grandmother') || 
                    voiceName.includes('mom') || voiceName.includes('mother')) {
                    return 'female';
                }
                if (voiceName.includes('grandpa') || voiceName.includes('grandfather') || 
                    voiceName.includes('dad') || voiceName.includes('father')) {
                    return 'male';
                }
                
                // ã©ã¡ã‚‰ã§ã‚‚ãªã„å ´åˆã¯nullã‚’è¿”ã™
                return null;
            }

            setupVoiceSettings() {
                const femaleContainer = document.getElementById('femaleVoices');
                const maleContainer = document.getElementById('maleVoices');

                femaleContainer.innerHTML = '';
                maleContainer.innerHTML = '';

                // æ¨å¥¨éŸ³å£°ã‚’æœ€åˆã«è¿½åŠ 
                this.recommendedVoices.female.forEach(recommendation => {
                    const voice = this.findRecommendedVoice(recommendation);
                    if (voice) {
                        const voiceOption = this.createVoiceOption(voice, recommendation);
                        femaleContainer.appendChild(voiceOption);
                    }
                });

                this.recommendedVoices.male.forEach(recommendation => {
                    const voice = this.findRecommendedVoice(recommendation);
                    if (voice) {
                        const voiceOption = this.createVoiceOption(voice, recommendation);
                        maleContainer.appendChild(voiceOption);
                    }
                });

                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éŸ³å£°ã‚’è¿½åŠ ï¼ˆæ€§åˆ¥åˆ†é¡æ”¹å–„ï¼‰
                this.addFallbackVoices(femaleContainer, maleContainer);
                
                // è¨­å®šã‚’å¾©å…ƒ
                this.restoreSettings();
            }

            addFallbackVoices(femaleContainer, maleContainer) {
                const addedVoices = new Set();
                
                // æ—¢ã«è¿½åŠ ã•ã‚ŒãŸéŸ³å£°ã‚’è¨˜éŒ²
                document.querySelectorAll('.voice-option').forEach(option => {
                    addedVoices.add(option.dataset.voiceName);
                });

                // æ€§åˆ¥ãŒåˆ¤å®šã§ããŸéŸ³å£°ã®ã¿ã‚’è¿½åŠ 
                this.availableVoices.forEach(voice => {
                    if (!addedVoices.has(voice.name)) {
                        const gender = this.determineVoiceGender(voice);
                        
                        if (gender === 'female' && femaleContainer.children.length < 6) {
                            const recommendation = {
                                name: voice.name,
                                description: 'åˆ©ç”¨å¯èƒ½ãªéŸ³å£°'
                            };
                            const voiceOption = this.createVoiceOption(voice, recommendation);
                            femaleContainer.appendChild(voiceOption);
                            addedVoices.add(voice.name);
                        } else if (gender === 'male' && maleContainer.children.length < 6) {
                            const recommendation = {
                                name: voice.name,
                                description: 'åˆ©ç”¨å¯èƒ½ãªéŸ³å£°'
                            };
                            const voiceOption = this.createVoiceOption(voice, recommendation);
                            maleContainer.appendChild(voiceOption);
                            addedVoices.add(voice.name);
                        }
                        // æ€§åˆ¥ãŒåˆ¤å®šã§ããªã„éŸ³å£°ã¯è¡¨ç¤ºã—ãªã„
                    }
                });
                
                // ã‚‚ã—éŸ³å£°ãŒå°‘ãªã™ãã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (femaleContainer.children.length === 0) {
                    this.addGenericVoiceOption(femaleContainer, 'åˆ©ç”¨å¯èƒ½ãªå¥³æ€§éŸ³å£°ãªã—');
                }
                if (maleContainer.children.length === 0) {
                    this.addGenericVoiceOption(maleContainer, 'åˆ©ç”¨å¯èƒ½ãªç”·æ€§éŸ³å£°ãªã—');
                }
            }

            addGenericVoiceOption(container, message) {
                const div = document.createElement('div');
                div.className = 'voice-option disabled';
                div.style.opacity = '0.5';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-sm text-gray-600">${message}</div>
                            <div class="text-xs text-gray-400">ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°ã‚’ä½¿ç”¨ã—ã¾ã™</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            }

            createVoiceOption(voice, recommendation) {
                const div = document.createElement('div');
                div.className = 'voice-option';
                div.dataset.voiceName = voice.name;
                
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-sm text-gray-800">${recommendation.name}</div>
                            <div class="text-xs text-gray-500">${recommendation.description}</div>
                        </div>
                        <button class="voice-preview-btn ml-2" data-voice-name="${voice.name}">
                            â–¶ï¸ ãƒ†ã‚¹ãƒˆ
                        </button>
                    </div>
                `;

                // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
                div.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('voice-preview-btn')) {
                        this.selectVoice(voice);
                        soundSystem.playClick();
                    }
                });

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
                const previewBtn = div.querySelector('.voice-preview-btn');
                previewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.previewVoice(voice);
                    soundSystem.playClick();
                });

                return div;
            }

            selectVoice(voice) {
                // ä»–ã®é¸æŠã‚’è§£é™¤
                document.querySelectorAll('.voice-option').forEach(option => {
                    option.classList.remove('selected');
                });

                // æ–°ã—ã„é¸æŠã‚’è¨­å®š
                const option = document.querySelector(`[data-voice-name="${voice.name}"]`);
                if (option) {
                    option.classList.add('selected');
                }

                this.settings.selectedVoice = voice;
                this.saveSettings();
                showNotification(`éŸ³å£°ã‚’ã€Œ${voice.name}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
            }

            previewVoice(voice) {
                if (!this.settings.enabled) return;

                const utterance = new SpeechSynthesisUtterance('Hello! This is a test of the selected voice.');
                utterance.voice = voice;
                utterance.lang = voice.lang;
                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            }

            speak(text) {
                if (!this.settings.enabled || !text) return;

                const utterance = new SpeechSynthesisUtterance(text);
                
                if (this.settings.selectedVoice) {
                    utterance.voice = this.settings.selectedVoice;
                    utterance.lang = this.settings.selectedVoice.lang;
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯éŸ³å£°ã‚’é¸æŠ
                    const englishVoices = this.availableVoices;
                    if (englishVoices.length > 0) {
                        const preferredVoice = englishVoices.find(v => 
                            v.localService || v.default || v.name.toLowerCase().includes('google')
                        ) || englishVoices[0];
                        utterance.voice = preferredVoice;
                        utterance.lang = preferredVoice.lang;
                    } else {
                        utterance.lang = 'en-US';
                    }
                }

                utterance.rate = 0.9;
                utterance.pitch = 1;
                
                speechSynthesis.cancel();
                speechSynthesis.speak(utterance);
            }

            toggleEnabled(enabled) {
                this.settings.enabled = enabled;
                this.saveSettings();
                
                const status = enabled ? 'ON' : 'OFF';
                showNotification(`éŸ³å£°å†ç”Ÿã‚’${status}ã«ã—ã¾ã—ãŸ`);
            }

            saveSettings() {
                const settingsToSave = {
                    enabled: this.settings.enabled,
                    selectedVoiceName: this.settings.selectedVoice ? this.settings.selectedVoice.name : null
                };
                localStorage.setItem('voiceSettings', JSON.stringify(settingsToSave));
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem('voiceSettings');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.settings.enabled = parsed.enabled !== false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯true
                        
                        // é¸æŠã•ã‚ŒãŸéŸ³å£°åã‚’ä¿å­˜ï¼ˆå®Ÿéš›ã®éŸ³å£°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å¾Œã§å¾©å…ƒï¼‰
                        this.savedVoiceName = parsed.selectedVoiceName;
                    }
                } catch (e) {
                    console.log('éŸ³å£°è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            restoreSettings() {
                // ON/OFFè¨­å®šã‚’å¾©å…ƒ
                const voiceEnabledToggle = document.getElementById('voiceEnabled');
                if (voiceEnabledToggle) {
                    voiceEnabledToggle.checked = this.settings.enabled;
                }

                // é¸æŠã•ã‚ŒãŸéŸ³å£°ã‚’å¾©å…ƒ
                if (this.savedVoiceName) {
                    const savedVoice = this.availableVoices.find(voice => 
                        voice.name === this.savedVoiceName
                    );
                    if (savedVoice) {
                        this.selectVoice(savedVoice);
                    }
                }
            }
        }

        const voiceSystem = new VoiceSettingsSystem();

        /* ----------------- é¸æŠè‚¢ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ©Ÿèƒ½ï¼ˆæ–°è¦è¿½åŠ ï¼‰ ----------------- */
        function shuffleOptions(originalOpts, correctAnswerIndex) {
            // å…ƒã®æ­£è§£é¸æŠè‚¢ã‚’ä¿å­˜
            const correctOption = originalOpts[correctAnswerIndex];
            
            // é¸æŠè‚¢é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            const shuffledOpts = [...originalOpts];
            
            // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
            for (let i = shuffledOpts.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOpts[i], shuffledOpts[j]] = [shuffledOpts[j], shuffledOpts[i]];
            }
            
            // æ–°ã—ã„æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¦‹ã¤ã‘ã‚‹
            const newCorrectIndex = shuffledOpts.indexOf(correctOption);
            
            return {
                shuffledOpts: shuffledOpts,
                newCorrectIndex: newCorrectIndex
            };
        }

        /* ----------------- æ›´æ–°ã•ã‚ŒãŸéŸ³å£°ç™ºéŸ³é–¢æ•° ----------------- */
        function speakWord(wordToSpeak) {
            voiceSystem.speak(wordToSpeak);
        }

        function isEnglishCategory() {
            return selectedCategories.some(categoryId => 
                categoryId.startsWith('words_') || categoryId.startsWith('phrases_') || categoryId.startsWith('grammar_')
            );
        }

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼å®šç¾© ----------------- */
        const categories = {
            geography: [
                {id: 'geo_world_overview', name: '1.ä¸–ç•Œã®å§¿'},
                {id: 'geo_japan_overview', name: '2.æ—¥æœ¬ã®å§¿'},
                {id: 'geo_world_life', name: '3.ä¸–ç•Œå„åœ°ã®äººã€…ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},
                {id: 'geo_asia', name: '4.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ã‚¸ã‚¢å·'},
                {id: 'geo_europe', name: '5.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},
                {id: 'geo_africa', name: '6.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚¢ãƒ•ãƒªã‚«å·'},
                {id: 'geo_north_america', name: '7.ä¸–ç•Œã®è«¸åœ°åŸŸã€€åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_south_america', name: '8.ä¸–ç•Œã®è«¸åœ°åŸŸã€€å—ã‚¢ãƒ¡ãƒªã‚«å·'},
                {id: 'geo_oceania', name: '9.ä¸–ç•Œã®è«¸åœ°åŸŸã€€ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},
                {id: 'geo_japan_features', name: '10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},
                {id: 'geo_japan_kyushu', name: '11.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¹å·åœ°æ–¹'},
                {id: 'geo_japan_chugoku', name: '12.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},
                {id: 'geo_japan_kinki', name: '13.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€è¿‘ç•¿åœ°æ–¹'},
                {id: 'geo_japan_chubu', name: '14.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€ä¸­éƒ¨åœ°æ–¹'},
                {id: 'geo_japan_kanto', name: '15.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€é–¢æ±åœ°æ–¹'},
                {id: 'geo_japan_tohoku', name: '16.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€æ±åŒ—åœ°æ–¹'},
                {id: 'geo_japan_hokkaido', name: '17.æ—¥æœ¬ã®è«¸åœ°åŸŸã€€åŒ—æµ·é“åœ°æ–¹'}
            ],
            history: [
                {id: 'hist_ancient', name: '1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬ã®æˆã‚Šç«‹ã¡'},
                {id: 'hist_ancient_state', name: '2.å¤ä»£å›½å®¶ã®æ­©ã¿ã¨æ±ã‚¢ã‚¸ã‚¢'},
                {id: 'hist_kamakura', name: '3.æ­¦å£«ã®ãŠã“ã‚Šã¨éŒå€‰å¹•åºœ'},
                {id: 'hist_muromachi', name: '4.ãƒ¢ãƒ³ã‚´ãƒ«ã®è¥²æ¥ã¨å®¤ç”ºå¹•åºœ'},
                {id: 'hist_unification', name: '5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘äººã¨ã®å‡ºä¼šã„ã¨å…¨å›½çµ±ä¸€'},
                {id: 'hist_edo_early', name: '6.æ±Ÿæˆ¸å¹•åºœã®æˆç«‹ã¨é–å›½'},
                {id: 'hist_edo_develop', name: '7.ç”£æ¥­ã®ç™ºé”ã¨å¹•åºœæ”¿æ²»ã®å±•é–‹'},
                {id: 'hist_opening', name: '8.æ¬§ç±³ã®é€²å‡ºã¨æ—¥æœ¬ã®é–‹å›½'},
                {id: 'hist_meiji', name: '9.æ˜æ²»ç¶­æ–°'},
                {id: 'hist_wars', name: '10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰ã¨æ—¥æœ¬ã®ç”£æ¥­é©å‘½'},
                {id: 'hist_wwi', name: '11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦ã¨æ—¥æœ¬'},
                {id: 'hist_wwii', name: '12.ä¸–ç•Œææ…Œã¨ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},
                {id: 'hist_postwar', name: '13.æˆ¦å¾Œã®æ—¥æœ¬ã®ç™ºå±•ã¨å›½éš›ç¤¾ä¼š'}
            ],
            civics: [
                {id: 'civics_modern', name: '1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},
                {id: 'civics_constitution', name: '2.äººé–“ã®å°Šé‡ã¨æ—¥æœ¬å›½æ†²æ³•'},
                {id: 'civics_democracy', name: '3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},
                {id: 'civics_economy', name: '4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'}
            ],
            chemistry: [
                {id: 'chemistry_basic', name: '1.ç‰©è³ªã¨ãã®æ€§è³ª'},
                {id: 'chemistry_gas', name: '2.æ°—ä½“ã®æ€§è³ª'},
                {id: 'chemistry_solution', name: '3.æ°´æº¶æ¶²ã®æ€§è³ª'},
                {id: 'chemistry_state', name: '4.çŠ¶æ…‹å¤‰åŒ–'},
                {id: 'chemistry_change', name: '5.ç‰©è³ªã®å¤‰åŒ–'},
                {id: 'chemistry_structure', name: '6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},
                {id: 'chemistry_reaction', name: '7.ç‰©è³ªã©ã†ã—ã®åŒ–å­¦å¤‰åŒ–'},
                {id: 'chemistry_mass', name: '8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},
                {id: 'chemistry_ion', name: '9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},
                {id: 'chemistry_acid', name: '10.é…¸ã€ã‚¢ãƒ«ã‚«ãƒªã€å¡©'},
                {id: 'chemistry_formula', name: '11.åŒ–å­¦å¼ï¼ˆå˜ä½“ãƒ»åŒ–åˆç‰©ï¼‰'},
                {id: 'chemistry_reaction_equation', name: '12.åŒ–å­¦åå¿œå¼ï¼ˆåˆ†è§£ãƒ»åŒ–åˆãƒ»é‚„å…ƒï¼‰'},
                {id: 'chemistry_ion_formula', name: '13.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼'},
                {id: 'chemistry_ion_reaction', name: '14.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦åå¿œå¼ï¼ˆé›»é›¢ãƒ»ã‚¤ã‚ªãƒ³åŒ–ãƒ»ä¸­å’Œï¼‰'}
            ],
            biology: [
                {id: 'biology_flower', name: '1.èŠ±ã®ã¤ãã‚Š'},
                {id: 'biology_plant', name: '2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Šã€æ¤ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_animal', name: '3.å‹•ç‰©ã®ç‰¹å¾´ã¨åˆ†é¡'},
                {id: 'biology_microscope', name: '4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},
                {id: 'biology_cell', name: '5.ç”Ÿç‰©ã¨ç´°èƒ'},
                {id: 'biology_plant_body', name: '6.æ¤ç‰©ã®ã‹ã‚‰ã ã®ã¤ãã‚Šã€æ¤ç‰©ã¨æ—¥å…‰'},
                {id: 'biology_digestion', name: '7.æ¶ˆåŒ–ã¨å¸å'},
                {id: 'biology_breathing', name: '8.å‘¼å¸'},
                {id: 'biology_circulation', name: '9.è¡€æ¶²ã®å¾ªç’°ã€æ’å‡ºã®ã—ãã¿'},
                {id: 'biology_response', name: '10.åˆºæ¿€ã¨åå¿œã€å‹•ç‰©ã®ã‹ã‚‰ã '},
                {id: 'biology_growth', name: '11.ç”Ÿç‰©ã®æˆé•·ã¨ç´°èƒã®å¤‰åŒ–'},
                {id: 'biology_reproduction', name: '12.ç”Ÿç‰©ã®ç”Ÿæ®–'},
                {id: 'biology_heredity', name: '13.éºä¼ã®è¦å‰‡æ€§ã¨éºä¼å­'},
                {id: 'biology_evolution', name: '14.ç”Ÿç‰©ã®é€²åŒ–ã€ç”Ÿæ…‹ç³»ã¨é£Ÿç‰©é€£é–'},
                {id: 'biology_environment', name: '15.è‡ªç„¶ã¨ç’°å¢ƒã€äººé–“ã¨è‡ªç„¶ç’°å¢ƒ'}
            ],
            physics: [
                {id: 'physics_light', name: '1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_sound', name: '2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_force', name: '3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},
                {id: 'physics_current', name: '4.é›»æµã¨é›»åœ§'},
                {id: 'physics_energy', name: '5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},
                {id: 'physics_magnetic', name: '6.é›»æµã¨ç£ç•Œ'},
                {id: 'physics_balance', name: '7.åŠ›ã®ã¤ã‚Šåˆã„ã¨åˆæˆãƒ»åˆ†è§£'},
                {id: 'physics_motion', name: '8.ç‰©ä½“ã®é‹å‹•'},
                {id: 'physics_pressure', name: '9.æ°´åœ§ã¨æµ®åŠ›'},
                {id: 'physics_work', name: '10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},
                {id: 'physics_energy_change', name: '11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},
                {id: 'physics_resources', name: '12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æºã®åˆ©ç”¨'}
            ],
            earth: [
                {id: 'earth_volcano', name: '1.ç«å±±'},
                {id: 'earth_earthquake', name: '2.åœ°éœ‡'},
                {id: 'earth_strata', name: '3.åœ°å±¤ã®ã§ãæ–¹'},
                {id: 'earth_weather', name: '4.æ°—è±¡ã®è¦³æ¸¬ã€å¤§æ°—åœ§ã¨åœ§åŠ›'},
                {id: 'earth_front', name: '5.æ°—å›£ã¨å‰ç·šã€æ—¥æœ¬ã®å¤©æ°—'},
                {id: 'earth_cloud', name: '6.é›²ã®ã§ãæ–¹ã¨æ°´è’¸æ°—'},
                {id: 'earth_celestial', name: '7.åœ°çƒã®å‹•ãã¨å¤©ä½“ã®å‹•ã'},
                {id: 'earth_solar', name: '8.å¤ªé™½ç³»ã®å¤©ä½“'},
                {id: 'earth_moon', name: '9.æœˆã¨æƒ‘æ˜Ÿã®è¦‹ãˆæ–¹ã€è‡ªç„¶ã®æµã¿ã¨ç½å®³'}
            ],
            english_words: [
                {id: 'words_time', name: 'æœˆãƒ»åºæ•°'},
                {id: 'words_week', name: 'æ›œæ—¥'},
                {id: 'words_timeday', name: 'æ™‚ãƒ»æ™‚é–“å¸¯ãªã©'},
                {id: 'words_season', name: 'å­£ç¯€ãƒ»å®¶æ—'},
                {id: 'words_sports', name: 'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},
                {id: 'words_job', name: 'è·æ¥­ãƒ»äººãƒ»å»ºç‰©ãƒ»æ–½è¨­'},
                {id: 'words_uncountable', name: 'æ•°ãˆã‚‰ã‚Œãªã„åè©'},
                {id: 'words_verb_important', name: 'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},
                {id: 'words_verb_various', name: 'ã„ã‚ã„ã‚ãªæ„å‘³ã‚’ã‚‚ã¤å‹•è©'},
                {id: 'words_verb_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„å‹•è©'},
                {id: 'words_verb_other', name: 'ãã®ä»–ã®é‡è¦å‹•è©'},
                {id: 'words_adj_quantity', name: 'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},
                {id: 'words_adj_various', name: 'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},
                {id: 'words_adj_adv', name: 'ãã®ä»–ã®é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},
                {id: 'words_adv_manner', name: 'æ§˜å­ã‚’è¡¨ã™å‰¯è©'}
            ],
            english_phrases: [
                {id: 'phrases_verb', name: 'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_set', name: 'ã‚»ãƒƒãƒˆã§è¦šãˆã¦ãŠããŸã„ç†Ÿèª'},
                {id: 'phrases_similar', name: 'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},
                {id: 'phrases_verb_other', name: 'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},
                {id: 'phrases_be', name: 'be å‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},
                {id: 'phrases_quantity', name: 'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_time_place', name: 'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},
                {id: 'phrases_important', name: 'ãã®ä»–ã®é‡è¦ç†Ÿèª'}
            ],
            english_grammar: [
                {id: 'grammar_irregular_past', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_irregular_same', name: 'ä¸è¦å‰‡å‹•è© - éå»å½¢ã¨éå»åˆ†è©ãŒåŒã˜'},
                {id: 'grammar_irregular_special', name: 'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹'},
                {id: 'grammar_be_past', name: 'be å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_regular', name: 'è¦å‰‡å‹•è© - éå»å½¢ãƒ»éå»åˆ†è©'},
                {id: 'grammar_third_person', name: 'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},
                {id: 'grammar_ing', name: 'å‹•è©ã® -ing å½¢'},
                {id: 'grammar_comparative', name: 'å½¢å®¹è© - æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},
                {id: 'grammar_more_most', name: 'moreã€most ã‚’ã¤ã‘ã‚‹å½¢å®¹è©'},
                {id: 'grammar_noun_plural', name: 'åè©ã®è¤‡æ•°å½¢'},
                {id: 'grammar_irregular_plural', name: 'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},
                {id: 'grammar_pronoun', name: 'äººç§°ä»£åè©'}
            ]
        };

        /* ----------------- ã‚²ãƒ¼ãƒ å¤‰æ•° ----------------- */
        let selectedCategories = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let totalCount = 0;
        let usedQuestions = [];
        let particleOffset = 0;
        let currentSubject = '';
        
        // æ–°ã—ãè¿½åŠ ã™ã‚‹å‡ºé¡Œå½¢å¼é–¢é€£ã®å¤‰æ•°
        let questionMode = 'random'; // 'random' ã¾ãŸã¯ 'sequential'
        let sequentialIndex = 0; // é †ç•ªé€šã‚Šå‡ºé¡Œç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        /* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            particle.style.fontSize = '18px';
            document.body.appendChild(particle);

            particleOffset += 30;
            if (particleOffset > 120) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2000);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /* ----------------- ç”»é¢é·ç§»é–¢æ•° ----------------- */
        function hideAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
        }

        function goBackToMain() {
            hideAllModals();
            document.getElementById('mainSubjectModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToSocial() {
            hideAllModals();
            document.getElementById('socialModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToScience() {
            hideAllModals();
            document.getElementById('scienceModal').classList.add('show');
            soundSystem.playClick();
        }

        function goBackToEnglish() {
            hideAllModals();
            document.getElementById('englishModal').classList.add('show');
            soundSystem.playClick();
        }

        /* ----------------- ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠã®åˆæœŸåŒ– ----------------- */
        function initCategorySelection() {
            // åœ°ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´è¡¨è¨˜ãªã—ï¼‰
            const geographyContainer = document.getElementById('geographyCategories');
            categories.geography.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('geography', category.id, btn);
                geographyContainer.appendChild(btn);
            });

            // æ­´å²ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const historyContainer = document.getElementById('historyCategories');
            categories.history.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('history', category.id, btn);
                historyContainer.appendChild(btn);
            });

            // å…¬æ°‘ã‚«ãƒ†ã‚´ãƒªãƒ¼
            const civicsContainer = document.getElementById('civicsCategories');
            categories.civics.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('civics', category.id, btn);
                civicsContainer.appendChild(btn);
            });

// åŒ–å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
const chemistryContainer = document.getElementById('chemistryCategories');

// ä¸­1
const grade1Label = document.createElement('div');
grade1Label.className = 'grade-label';
grade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
chemistryContainer.appendChild(grade1Label);
categories.chemistry.slice(0, 4).forEach(category => {
    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.innerHTML = category.name;
    btn.dataset.categoryId = category.id;
    btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
    chemistryContainer.appendChild(btn);
});

// ä¸­2
const grade2Label = document.createElement('div');
grade2Label.className = 'grade-label';
grade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
chemistryContainer.appendChild(grade2Label);
categories.chemistry.slice(4, 8).forEach(category => {
    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.innerHTML = category.name;
    btn.dataset.categoryId = category.id;
    btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
    chemistryContainer.appendChild(btn);
});

// ä¸­3
const grade3Label = document.createElement('div');
grade3Label.className = 'grade-label';
grade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
chemistryContainer.appendChild(grade3Label);
categories.chemistry.slice(8, 10).forEach(category => { // â† ã“ã“ã‚’ slice(8, 10) ã«ä¿®æ­£
    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.innerHTML = category.name;
    btn.dataset.categoryId = category.id;
    btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
    chemistryContainer.appendChild(btn);
});

// åŒ–å­¦å¼ãƒ»åŒ–å­¦åå¿œå¼ï¼ˆç‹¬ç«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
const formulaLabel = document.createElement('div');
formulaLabel.className = 'grade-label';
formulaLabel.textContent = 'åŒ–å­¦å¼ãƒ»åŒ–å­¦åå¿œå¼';
chemistryContainer.appendChild(formulaLabel);
categories.chemistry.slice(10, 14).forEach(category => {
    const btn = document.createElement('button');
    btn.className = 'category-btn';
    btn.innerHTML = category.name;
    btn.dataset.categoryId = category.id;
    btn.onclick = () => toggleCategorySelection('chemistry', category.id, btn);
    chemistryContainer.appendChild(btn);
});

            // ç”Ÿç‰©ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const biologyContainer = document.getElementById('biologyCategories');
            // ä¸­1
            const bioGrade1Label = document.createElement('div');
            bioGrade1Label.className = 'grade-label';
            bioGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade1Label);
            categories.biology.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                biologyContainer.appendChild(btn);
            });
            // ä¸­2
            const bioGrade2Label = document.createElement('div');
            bioGrade2Label.className = 'grade-label';
            bioGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade2Label);
            categories.biology.slice(3, 10).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                biologyContainer.appendChild(btn);
            });
            // ä¸­3
            const bioGrade3Label = document.createElement('div');
            bioGrade3Label.className = 'grade-label';
            bioGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            biologyContainer.appendChild(bioGrade3Label);
            categories.biology.slice(10).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('biology', category.id, btn);
                biologyContainer.appendChild(btn);
            });

            // ç‰©ç†ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const physicsContainer = document.getElementById('physicsCategories');
            // ä¸­1
            const phyGrade1Label = document.createElement('div');
            phyGrade1Label.className = 'grade-label';
            phyGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade1Label);
            categories.physics.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                physicsContainer.appendChild(btn);
            });
            // ä¸­2
            const phyGrade2Label = document.createElement('div');
            phyGrade2Label.className = 'grade-label';
            phyGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade2Label);
            categories.physics.slice(3, 6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                physicsContainer.appendChild(btn);
            });
            // ä¸­3
            const phyGrade3Label = document.createElement('div');
            phyGrade3Label.className = 'grade-label';
            phyGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            physicsContainer.appendChild(phyGrade3Label);
            categories.physics.slice(6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('physics', category.id, btn);
                physicsContainer.appendChild(btn);
            });

            // åœ°å­¦ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå­¦å¹´ã”ã¨ã«åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
            const earthContainer = document.getElementById('earthCategories');
            // ä¸­1
            const earthGrade1Label = document.createElement('div');
            earthGrade1Label.className = 'grade-label';
            earthGrade1Label.textContent = 'ä¸­å­¦1å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade1Label);
            categories.earth.slice(0, 3).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                earthContainer.appendChild(btn);
            });
            // ä¸­2
            const earthGrade2Label = document.createElement('div');
            earthGrade2Label.className = 'grade-label';
            earthGrade2Label.textContent = 'ä¸­å­¦2å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade2Label);
            categories.earth.slice(3, 6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                earthContainer.appendChild(btn);
            });
            // ä¸­3
            const earthGrade3Label = document.createElement('div');
            earthGrade3Label.className = 'grade-label';
            earthGrade3Label.textContent = 'ä¸­å­¦3å¹´ç”Ÿ';
            earthContainer.appendChild(earthGrade3Label);
            categories.earth.slice(6).forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('earth', category.id, btn);
                earthContainer.appendChild(btn);
            });

            // è‹±å˜èªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishWordsContainer = document.getElementById('englishWordsCategories');
            categories.english_words.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_words', category.id, btn);
                englishWordsContainer.appendChild(btn);
            });

            // è‹±ç†Ÿèªã‚«ãƒ†ã‚´ãƒªãƒ¼
            const englishPhrasesContainer = document.getElementById('englishPhrasesCategories');
            categories.english_phrases.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_phrases', category.id, btn);
                englishPhrasesContainer.appendChild(btn);
            });

            // èªå½¢å¤‰åŒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆæ–°è¦è¿½åŠ ï¼‰
            const englishGrammarContainer = document.getElementById('englishGrammarCategories');
            categories.english_grammar.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = category.name;
                btn.dataset.categoryId = category.id;
                btn.onclick = () => toggleCategorySelection('english_grammar', category.id, btn);
                englishGrammarContainer.appendChild(btn);
            });
        }

        function toggleCategorySelection(subject, categoryId, buttonElement) {
            soundSystem.playClick();
            if (selectedCategories.includes(categoryId)) {
                selectedCategories = selectedCategories.filter(id => id !== categoryId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(categoryId);
                buttonElement.classList.add('active');
            }

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const camelCase = subject.split('_')
                .map((word, index) => index === 0 ? word.charAt(0).toUpperCase() + word.slice(1) : word.charAt(0).toUpperCase() + word.slice(1))
                .join('');
            const startButton = document.getElementById(`start${camelCase}Quiz`);

            if (startButton) {
                startButton.disabled = selectedCategories.length === 0;
            }
        }

        function startSelectedQuiz(subject, subjectName) {
            currentSubject = subject;
            hideAllModals();
            document.getElementById('currentCategory').textContent = `${subjectName} - ${selectedCategories.length}å˜å…ƒé¸æŠ`;
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
            const floatingBtn = document.getElementById('changeSubject');
            floatingBtn.classList.remove('hidden');
            floatingBtn.style.display = 'flex';

            // éŸ³å£°è¨­å®šãƒœã‚¿ãƒ³ã‚’è‹±èªç§‘ç›®ã§ã®ã¿è¡¨ç¤º
            const voiceBtn = document.getElementById('voiceSettingsButton');
            if (isEnglishCategory()) {
                voiceBtn.classList.remove('hidden');
                voiceBtn.style.display = 'flex';
            } else {
                voiceBtn.classList.add('hidden');
            }

            // çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ
            correctCount = 0;
            wrongCount = 0;
            totalCount = 0;
            usedQuestions = [];
            sequentialIndex = 0; // é †ç•ªé€šã‚Šå‡ºé¡Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚ãƒªã‚»ãƒƒãƒˆ
            updateStats();
            showNotification(`${subjectName}ã®${selectedCategories.length}å˜å…ƒã‚’é¸æŠã—ã¾ã—ãŸï¼`);
        }

        function updateStats() {
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('totalCount').textContent = totalCount;
        }

        function setQuestionMode(mode) {
            questionMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');
            
            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™';
                // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã¯ä½¿ç”¨æ¸ˆã¿å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆ
                usedQuestions = [];
                showNotification('ğŸ² ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã—ã¾ã™';
                // é †ç•ªãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                sequentialIndex = 0;
                showNotification('ğŸ“‹ é †ç•ªé€šã‚Šå‡ºé¡Œã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
            }
        }

        /* ----------------- ã‚¯ã‚¤ã‚ºæ©Ÿèƒ½ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«å¯¾å¿œç‰ˆï¼‰ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('å˜å…ƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å•é¡Œã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                // problemDatabaseãŒå­˜åœ¨ã—ã€è©²å½“ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof problemDatabase !== 'undefined' && problemDatabase && problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                } else {
                    console.warn(`å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${categoryId}`);
                }
            });

            if (allProblems.length === 0) {
                showNotification('é¸æŠã•ã‚ŒãŸå˜å…ƒã®å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚problems.jsãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('ğŸ‰ å…¨å•ã‚¯ãƒªã‚¢ï¼å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            // å‡ºé¡Œå½¢å¼ã«å¿œã˜ãŸå•é¡Œé¸æŠ
            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                // é †ç•ªé€šã‚Šå‡ºé¡Œ
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('ğŸ”„ å…¨å•é¡Œã‚’ä¸€å‘¨ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆé‡è¦ãªæ–°æ©Ÿèƒ½ï¼ï¼‰
            const shuffleResult = shuffleOptions(quiz.opts, quiz.ans);
            const shuffledOpts = shuffleResult.shuffledOpts;
            const newCorrectIndex = shuffleResult.newCorrectIndex;

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            // è‹±èªã®å•é¡Œãªã‚‰éŸ³å£°ã§ç™ºéŸ³
            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            // åˆæœŸçŠ¶æ…‹ï¼šãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false; // æœ€åˆã®å›ç­”ã®ã¿ãƒ•ãƒ©ã‚°

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸé¸æŠè‚¢ã§ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
            shuffledOpts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    // è‹±èªã®é¸æŠè‚¢ãªã‚‰éŸ³å£°ã§ç™ºéŸ³
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    // æœ€åˆã®å›ç­”ã®ã¿çµ±è¨ˆã‚’æ›´æ–°
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        if (i === newCorrectIndex) { // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§åˆ¤å®š
                            correctCount++;
                            soundSystem.playCorrect();
                            showNotification('æ­£è§£ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼');
                            createParticle('âœ¨ æ­£è§£ï¼', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
                        } else {
                            wrongCount++;
                            soundSystem.playWrong();
                        }
                        updateStats();
                        
                        // æœ€åˆã®å›ç­”å¾Œï¼šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    // æ¯å›ã®é¸æŠè‚¢ã«å¯¾ã™ã‚‹è§£èª¬è¡¨ç¤º
                    if (i === newCorrectIndex) {
                        msgEl.innerHTML = `ğŸ‰ æ­£è§£ï¼${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `âŒ æ®‹å¿µ...ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${shuffledOpts[newCorrectIndex]}ã€ã§ã™ã€‚${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });

            // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã®å‡¦ç†
            nextBtn.onclick = () => {
                soundSystem.playClick();
                loadNextQuiz();
            };

            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
            backBtn.onclick = () => {
                soundSystem.playClick();
                modal.classList.remove('show');
                showNotification('ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            // é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å•é¡Œã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                if (typeof problemDatabase !== 'undefined' && problemDatabase && problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) return;

            if (usedQuestions.length >= allProblems.length) {
                usedQuestions = [];
                showNotification('ğŸ‰ å…¨å•ã‚¯ãƒªã‚¢ï¼å•é¡Œã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            // å‡ºé¡Œå½¢å¼ã«å¿œã˜ãŸå•é¡Œé¸æŠ
            let quiz;
            let remainingCount;
            
            if (questionMode === 'random') {
                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                // é †ç•ªé€šã‚Šå‡ºé¡Œ
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('ğŸ”„ å…¨å•é¡Œã‚’ä¸€å‘¨ã—ã¾ã—ãŸï¼æœ€åˆã‹ã‚‰å†é–‹ã—ã¾ã™');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆæ¬¡ã®å•é¡Œã§ã‚‚é©ç”¨ï¼‰
            const shuffleResult = shuffleOptions(quiz.opts, quiz.ans);
            const shuffledOpts = shuffleResult.shuffledOpts;
            const newCorrectIndex = shuffleResult.newCorrectIndex;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è¦ç´ ã‚’ç›´æ¥æ›´æ–°
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (æ®‹ã‚Š${remainingCount}å•)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            // è‹±èªã®å•é¡Œãªã‚‰éŸ³å£°ã§ç™ºéŸ³
            if (isEnglishCategory()) {
                speakWord(quiz.q);
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false; // æœ€åˆã®å›ç­”ã®ã¿ãƒ•ãƒ©ã‚°

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸé¸æŠè‚¢ã‚’å†ç”Ÿæˆ
            shuffledOpts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    // è‹±èªã®é¸æŠè‚¢ãªã‚‰éŸ³å£°ã§ç™ºéŸ³
                    if (isEnglishCategory()) {
                        speakWord(txt);
                    }
                    
                    // æœ€åˆã®å›ç­”ã®ã¿çµ±è¨ˆã‚’æ›´æ–°
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalCount++;
                        if (i === newCorrectIndex) { // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¾Œã®æ­£è§£ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§åˆ¤å®š
                            correctCount++;
                            soundSystem.playCorrect();
                            showNotification('æ­£è§£ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼');
                            createParticle('âœ¨ æ­£è§£ï¼', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
                        } else {
                            wrongCount++;
                            soundSystem.playWrong();
                        }
                        updateStats();
                        
                        // æœ€åˆã®å›ç­”å¾Œï¼šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }
                    
                    // æ¯å›ã®é¸æŠè‚¢ã«å¯¾ã™ã‚‹è§£èª¬è¡¨ç¤º
                    if (i === newCorrectIndex) {
                        msgEl.innerHTML = `ğŸ‰ æ­£è§£ï¼${quiz.exp || ''}`;
                        msgEl.style.color = '#10b981';
                    } else {
                        msgEl.innerHTML = `âŒ æ®‹å¿µ...ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${shuffledOpts[newCorrectIndex]}ã€ã§ã™ã€‚${quiz.exp || ''}`;
                        msgEl.style.color = '#ef4444';
                    }
                    explanationEl.classList.add('has-content');
                };
                optDiv.appendChild(btn);
            });
        }

        /* ----------------- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ----------------- */
        function initEventListeners() {
            // ãƒ¡ã‚¤ãƒ³æ•™ç§‘é¸æŠ
            document.querySelectorAll('[data-subject]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    soundSystem.playClick();
                    const subject = e.currentTarget.dataset.subject;
                    hideAllModals();
                    document.getElementById(subject + 'Modal').classList.add('show');
                });
            });

            // è©³ç´°ã‚«ãƒ†ã‚´ãƒªé¸æŠ
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    soundSystem.playClick();
                    const category = e.currentTarget.dataset.category;
                    selectedCategories = []; // ãƒªã‚»ãƒƒãƒˆ
                    hideAllModals();
                    
                    // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã«å¤‰æ›
                    const modalId = category.split('_')
                        .map((word, index) => index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1))
                        .join('');
                    
                    document.getElementById(modalId + 'Modal').classList.add('show');
                });
            });

            // ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ç¾¤
            document.getElementById('startGeographyQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('geography', 'ğŸ—ºï¸ åœ°ç†');
            });
            document.getElementById('startHistoryQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('history', 'ğŸ›ï¸ æ­´å²');
            });
            document.getElementById('startCivicsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('civics', 'âš–ï¸ å…¬æ°‘');
            });
            document.getElementById('startChemistryQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('chemistry', 'ğŸ§ª åŒ–å­¦');
            });
            document.getElementById('startBiologyQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('biology', 'ğŸ§¬ ç”Ÿç‰©');
            });
            document.getElementById('startPhysicsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('physics', 'âš›ï¸ ç‰©ç†');
            });
            document.getElementById('startEarthQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('earth', 'ğŸŒ åœ°å­¦');
            });
            document.getElementById('startEnglishWordsQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_words', 'ğŸ“ è‹±å˜èª');
            });
            document.getElementById('startEnglishPhrasesQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_phrases', 'ğŸ’¬ è‹±ç†Ÿèª');
            });
            document.getElementById('startEnglishGrammarQuiz').addEventListener('click', () => {
                soundSystem.playSuccess();
                startSelectedQuiz('english_grammar', 'ğŸ“˜ èªå½¢å¤‰åŒ–');
            });

            // ãƒ¡ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('startQuizButton').addEventListener('click', () => {
                soundSystem.playSuccess();
                openQuiz();
            });

            // å‡ºé¡Œå½¢å¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('random');
            });
            
            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // æ•™ç§‘å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆæ–°è¦è¿½åŠ ï¼‰
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                soundSystem.playClick();
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                document.getElementById('voiceSettingsButton').classList.add('hidden');
                goBackToMain();
            });

            // éŸ³å£°è¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('voiceSettingsButton').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                soundSystem.playClick();
                document.getElementById('voiceSettingsModal').classList.add('show');
            });

            // éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            document.getElementById('closeVoiceSettings').addEventListener('click', () => {
                soundSystem.playClick();
                document.getElementById('voiceSettingsModal').classList.remove('show');
            });

            // éŸ³å£°ON/OFFåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('voiceEnabled').addEventListener('change', (e) => {
                voiceSystem.toggleEnabled(e.target.checked);
                soundSystem.playClick();
            });
        }

        /* ----------------- å…¨ãƒœã‚¿ãƒ³ã«åŠ¹æœéŸ³ã‚’è¿½åŠ  ----------------- */
        function addSoundToButtons() {
            document.addEventListener('click', (e) => {
                if (e.target.matches('button:not([data-sound-added])') && !e.target.disabled) {
                    e.target.setAttribute('data-sound-added', 'true');
                }
            });
            
            // ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢ã®è¿½åŠ è¨­å®š
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCategorySelection();
            initEventListeners();
            addSoundToButtons();
            
            // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
            document.getElementById('changeSubject').classList.add('hidden');
            document.getElementById('voiceSettingsButton').classList.add('hidden');
            
            // ã‚¿ãƒƒãƒ—æ‹¡å¤§é˜²æ­¢ã®æœ€çµ‚è¨­å®š
            document.body.style.webkitTouchCallout = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.userSelect = 'none';

            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œï¼‰
            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
        });
    </script>
</body>
</html>